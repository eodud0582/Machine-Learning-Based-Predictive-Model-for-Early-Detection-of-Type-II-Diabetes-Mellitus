# 머신러닝 기반 제2형 당뇨병 진단 사전 예측 모형
### 실제 진료 데이터(Real World Data, RWD)를 활용한 당뇨병 진단 사전 예측 모형 개발

---
## 프로젝트 배경

11월의 두 번째 일요일은 국제당뇨병연맹(IDF)와 세계보건기구(WHO)가 정한 세계당뇨의날(World Diabetes Day)이다. 폐렴, 고혈압, 뇌졸증 등 유병률, 심각도 등에서 중요도가 큰 질환들은 모두 자기만의 기념일을 가지고 있다. 그만큼 당뇨병은 점점 유병률이 증가하고 우리 일상을 위협하는 심각한 질환이라는 의미이다.

'당뇨'란 혈액 속의 포도당 수치가 정상인보다 높은 상태를 말하며, 우리 몸이 섭취한 음식물을 에너지로 적절하게 사용되지 못 하고 포도당이 소변으로 배출된다고 하여 이름 붙여진 병이다. 정상인의 경우 소변으로 당이 넘쳐나지 않을 정도로 혈당이 조절된다. 여기에는 췌장에서 분비되는 '인슐린'이라는 호르몬이 중요한 작용을 한다. 이러한 인슐린이 모자라거나 제대로 일을 못 하는 상태가 되면 혈당이 상승하며, 이로 인해 혈당이 지속적으로 높은 상태가 된다. 이러한 상태를 당뇨병이라고 하는데, 이렇게 혈당이 높은 상태로 오랜 시간이 지나면 심근경색, 뇌졸중, 망막질환, 신장질환, 동맥경화와 같은 만성 합병증을 일으킬 수 있는 무서운 질환이다.

코로나19(코로나 바이러스) 이후 실내 활동이 증가하고, 일상 생활 활동량 감소, 운동 빈도와 운동량의 감소, 식이 변화 등 일상 생활에서의 많은 변화가 있었다. 장기화 된 코로나 상황 속에서, 대한비만학회의 '코로나19시대 국민 체중 관리 현황 및 인식 조사'에 따르면 10명 중 약 5명은 코로나 이후 뭄무게가 3kg 이상 증가한 것으로 나타났다. 또한, 많은 사람들이 재택 근무, 온라인 수업 등으로 불규칙적인 생활과 식습관으로 영양 불균형의 상태 등도 겪고 있다. 하지만 더 큰 문제는, 바로 이러한 모든 요인들이 당뇨 유병률을 증가시키는 요인이 된다는 것이다.

전 세계의 위협이 되고 있는 코로나19로 인해 당뇨병 환자들의 우려는 더욱 커졌다. 당뇨병 환자는 코로나19에 특히 더 취약하다. 당뇨병은 우리 몸의 면역체계를 무너뜨려 감염병에 취약하게 만들며, 특히 당뇨병 환자는 일반인에 비해 코로나19의 감염 위험이 1.2배 더 높아 더 쉽게 감염 될 수 있다고 한다. 또한, 당뇨병은 만성질환 중에서도 가장 코로나19의 예방에 주의를 기울여야 하는 것으로 나타났다. '코로나19에 어떤 사람들이 더 위험한가?'라는 질문에 미 질병통제예방센터(CDC)는 “지금까지의 연구 결과에 의하면 65세 이상의 노인, 장기요양시설 생활자, 만성 폐질환, 천식, 비만, 당뇨병 등 기저질환을 가진 사람들에게 더 위험할 수 있다”고 답했는데, 실제로 일반인에 비해 당뇨병 환자가 코로나19에 감염됐을 경우 예후가 나쁜 것으로 알려져 있다. 대한당뇨병학회에 따르면 국내 코로나19 환자의 14.5~21.8%가 당뇨병 환자였고, 국내 5천여명의 코로나19 환자를 대상으로 한 연구에 따르면 당뇨병 환자가 코로나19 감염 시 기계호흡이 필요한 경우는 1.93배, 사망률은 2.66배 높았다. 또한, 인슐린 치료를 받는 당뇨병 환자들은 감염 위험이 25% 증가했다. 미국의 경우 코로나19 감염증 사망자 중 40%가 당뇨병 환자였다는 한 연구 결과도 나왔다.

그렇기에 코로나19 시대의 당뇨병 자가관리는 더욱 중요해졌다. 특히 당뇨병에 취약한 한국인의 특성을 고려할 때, 만약 자기의 건강상태와 당뇨병 위험을 사전에 예측 할 수 있다면, 당뇨병으로 진행되는 것을 적절한 사전 대응과 신체 및 혈당 관리를 통해 예방 할 수 있을 것이다. 이는 나아가 코로나19 감염을 예방하고 발생률 감소에도 영향을 줄 수 있을 것이며, 코로나19로 인한 중증도와 사망률 또한 감소시킬 수 있을 것이다. 그것을 목적으로, 이 프로젝트를 통해 머신러닝과 실제 진료 데이터를 활용하여 당뇨병 진단에 대한 사전 예측 모형을 개발하게 되었다.

---
## 데이터 소개
당뇨병 사전 진단 예측 모델링을 위해 당뇨병 관련 실제 진료 데이터/실사용데이터(Real World Data, RWD)를 확보하여 사용하였다. 데이터셋은 성별, 나이 등 환자에 대한 기본 정보와 당뇨병 진단 여부, 그리고 혈압, 혈당, 콜레스테롤, 간, 신장 등과 관련된 여러 검사 수치에 대한 데이터로 이루어져 있다.

총 2,438개의 행과 26개의 컬럼/피처로 구성되어 있는데, 이 중 당뇨병 진단을 받은 데이터가 206개인 불균형 데이터이다.

---
## EDA 및 전처리

### 각 피처별 분포도

![image](https://user-images.githubusercontent.com/38115693/147487886-2d334533-b961-4329-b518-6b92a723abad.png)

각 피처별 분포도 조회 결과, age, Wt, BMI, SBP, PR 등 일부 피처들을 제외한 대부분의 피처가 정규성을 띄고 있는 것으로 보인다. 하지만 Cr, AST, ALT, GGT, ALP 등이 왼쪽으로 치우친 분포를 보인다.

### 라벨별 각 피처 분포도
![image](https://user-images.githubusercontent.com/38115693/147484996-1f8a17f3-2d3a-4ee3-af73-69b5245a755d.png)

종속변수인 labels별(당뇨병 진단을 받은 경우 1, 아닌 경우 0) 각 피처의 분포도 확인 결과, 많은 변수들이 당뇨병 진단 여부와 상관없이 비슷한 분포를 띄고 있는 것처럼 보인다. 그 중에서 눈에 띄는 것은 혈당과 관련 된 피처들인 HbA1c, FBG, HDL 등인데, 혈당 관련 수치는 당뇨병 진단을 받은 집단이 좀 더 높은 값에 분포해 있는 것으로 보인다. 각 라벨별 피처의 평균값을 계산해 보면, 대부분의 피처에서 당뇨병 진단을 받은 데이터인 labels 1의 평균 수치가 더 높게 나타난다. 그런데 HDL의 경우 labels 0이 55.5로 labels 1의 49.8에 비해 더 높은 평균 수치를 가지고 있다. 당뇨병 진단을 받은 데이터의 고밀도 콜레스테롤(HDL)이 낮은 값에 분포해 있는데, 이 수치가 낮을 수록 저밀도 콜레스테롤 (LDL)을 잘 배출하지 못하게 된다. 이로 인해, 산화된 LDL이 혈전이 발생하여 혈압이 증가하고 모세혈관 괴사가 발생 할 수 있다.

### 각 피처별 분포도

![image](https://user-images.githubusercontent.com/38115693/147485404-fa76fccc-bf2c-4350-9514-a6b4a38dfbd5.png)

각 피처별 분포도를 보면 대부분의 피처들에 이상치로 보이는 값들이 존재한다. 하지만 조사 결과, 이러한 수치들 또한 의미가 있는 것으로 판단되어 제거하지 않고 그대로 사용하는 것으로 결정하였다. 예를 들어, TG가 1000mg/dL이 넘는 경우는 심한 고중성지방혈증으로 췌장염 발생의 위험이 증가하는데, 고중성지방혈증 환자 다수가 당뇨와 고혈압 등 대사성질환을 함께 가진 경우가 많다.

### 피처별 상관관계

<img src="https://user-images.githubusercontent.com/38115693/147489463-6a5c8922-0b9a-4693-b00a-bde84458eebd.png" width="70%" height="">

아래의 변수들간 강한 양의 상관관계(0.7<=r)를 보인다.
- Wt-Ht
- BMI-Ht
- DBP-SBP
- LDL-TC (매우 강한 0.9<=r)
- ALT-AST

비교적 강한 음의 상관관계(0.5<=r<0.7)를 보이는 변수들은 아래와 같다.
- CrCl-Cr

### 다중회귀분석

<img src="https://user-images.githubusercontent.com/38115693/147489857-6b0dd59b-7ac9-4e9e-ac5a-1604185787c8.png" width="30%" height="">

Labels에 대하여 연속형 독립변수들로 회귀분석을 실시한 결과:
- 결정계수(R-sqaured)는 전체 데이터 중 해당 회귀모델이 설명 할 수 있는 데이터의 비율, 회귀식의 설명력을 나타내는데(1에 가까울수록 높은 설명력), 여기선 0.218로 모형적합도는 낮은 편이다.
- F-statistic은 32.02, p-value(Prob(F-statistics))는 1.46e-112로 0.05 이하이니 통계적으로 유의하며, 변수끼리 관련있다고 판단된다.
- 회귀계수(coef)는 상대적으로 HbA1c가 0.159로 가장 높다.
- t-test결과, 독립변수와 종속변수 사이의 상관관계를 의미하는 t 값(값이 클수록 상관도가 큼)이 상대적으로 큰 변수들로는 age, HbA1c, FBG, TC, GGT, ALP이다.
- 독립변수들간의 유의확률(P>|t|; p-value)을 보면, 이 age, HbA1c, FBG, TC, GGT, ALP 변수들이 통계적으로 유의한 것으로 나타났다(0.05보다 작아야 유의미).

### VIF(Variance Inflation Factor)

VIF란 독립변수를 다른 독립변수로 선형회귀한 성능을 나타내며, 다른 독립변수에 의존하는 가장 의존적인 변수를 찾을 수 있다 (다른 변수에 의존적일 수록 VIF가 커진다).

<img src="https://user-images.githubusercontent.com/38115693/147490333-786c338e-588e-414b-9a85-7d830ac5ccf2.png" width="13%" height="">

Ht, Wt, BMI, SBP, DBP, HbA1c, FBG, TC, LDL, Alb 등이 높은 VIF 값을 보인다. 다른 독립변수들에 의존적인 변수들임을 의미한다.

VIF 값이 가장 큰 변수들 중 Ht, Wt를 먼저 제외하고, 이후 DBP, TC, Alb 변수들도 순차적으로 제외 한 후 VIF를 다시 계산해 보았다. 이 VIF 값은 이후 예측 모델링시 전처리 과정에서 참고 할 것이다.

<img src="https://user-images.githubusercontent.com/38115693/147490591-12a05a97-8f76-419f-b301-caba2b59e69e.png" width="10%" height="400"> <img src="https://user-images.githubusercontent.com/38115693/147490637-b1af2608-1320-4115-88bb-d105a97c35a9.png" width="10%" height="400">

### 당뇨병 진단 데이터 특성 조회

이어서, 당뇨병 진단을 받은 데이터(labels=1)에 대한 특성들을 살펴보았으며, 종속변수와의 상관관계가 높아보이는 독립변수들 위주로 조회하였다.

**당뇨병 진단을 받은 사람들의 성별 조회**

<img src="https://user-images.githubusercontent.com/38115693/147491151-79f0adea-648e-4b2c-86f8-fee3919649b1.png" width="40%" height="">

- 여성보다 남성이 더 많다.

**당뇨병 진단을 받은 사람들의 연령 조회**

<img src="https://user-images.githubusercontent.com/38115693/147491301-bd7bfad2-f3cc-466f-afb7-cb2b8199839b.png" width="40%" height="">

- 연령대로 구분하여 범주화한 후 표현하였다. 연령대가 높은 순서대로 많은 빈도수를 보인다.

**당뇨병 진단을 받은 사람들의 체질량지수(BMI) 조회**

<img src="https://user-images.githubusercontent.com/38115693/147491478-b46878e6-6bb3-4daf-a78d-3b2653b8f9de.png" width="40%" height="">

- 상위 15개 수치를 조회한 것인데, 23 이상의 수치에 대한 빈도수가 높다. 23이상이면 비만 전단계이고, 25이상부터 비만으로 부른다. 

**당뇨병 진단을 받은 사람들의 당화혈색소(HbA1c) 조회**

<img src="https://user-images.githubusercontent.com/38115693/147493085-0e9a450d-dabf-4691-a8c5-9fede6ff6730.png" width="40%" height="">

- 상위 15개 수치 값 조회 결과, HbA1c의 5.7 이상의 빈도수가 많은 것으로 나타난다. 5.7-6.4%는 당뇨 전단계로 부르며, 6.5% 이상은 당뇨로 진단한다.

**당뇨병 진단을 받은 사람들의 공복혈당(FBG) 조회**

<img src="https://user-images.githubusercontent.com/38115693/147493131-86f270cb-f369-4e4f-b4c8-590a29fa5e8e.png" width="40%" height="">

- 상위 15개 수치 값 조회 결과, 100 이상의 수치 값들에 대한 빈도수가 많다. 100-125는 공복혈당장애(당뇨병 전단계)이며, 126 이상은 당뇨병으로 진단한다.

**당뇨병 진단을 받은 사람들의 총 콜레스테롤(TC) 조회**

<img src="https://user-images.githubusercontent.com/38115693/147493176-e520f3d7-9a49-474b-99bc-a838d1c101fa.png" width="40%" height="">

**당뇨병 진단을 받은 사람들의 감마글루타밀전이효소(GGT) 조회**

<img src="https://user-images.githubusercontent.com/38115693/147493255-adcfa5d1-8a7d-4345-b267-4d3fd839d64c.png" width="40%" height="">

**당뇨병 진단을 받은 사람들의 알칼라인산분해효소(ALP) 조회**

<img src="https://user-images.githubusercontent.com/38115693/147493284-2dac9629-2ca4-4dba-9964-f6db2e9d1db8.png" width="40%" height="">

### 결측치 처리

<img src="https://user-images.githubusercontent.com/38115693/147493976-370db9bb-482e-4367-a416-b4b531f6383e.png" width="40%" height="">

결측치 조회 결과 PR, TG, LDL, HDL, Alb, ALP 피처에서 결측치가 확인 되었으며, 아래와 같이 처리하였다.
- PR의 경우 age 피처를 연령대별로 나누어 범주화한 피처를 사용하여, 동일한 연령대 PR의 평균값으로 대체하였다. 
- TG의 경우 총 콜레스테롤(TC) 산식(TC = LDL + HDL + TG/5)을 이용해 역산을 통해 TG를 계산하여 채웠다.
- Index 254번 데이터는 TG, LDL, HDL, Alb, AlP 모두 Null값이어서 해당 row 전체를 삭제하였다.

### 각 검사 수치에 대한 범주형 컬럼 추가 생성

![image](https://user-images.githubusercontent.com/38115693/147495420-d4b0e495-a424-4c63-afba-1a8057e99f16.png)

각 검사항목별로 정상 또는 판단 기준 범위에 따라 나누고 그룹화한/범주화한 파생 변수를 생성하였다. 추가적으로, 맥압, BUN/Cr 비율, AST/ALT 비율 등 당뇨병 진단과 밀접하게 관련된 다른 검사에 대해서도 조사하여 산식을 적용하여 범주화 된 변수를 생성하였고, DLP(이상지질혈증), MS(대사증후군) 등 당뇨로 발생 할 수 있는 질병과 합병증에 대한 정보도 확인하여 관련 산식을 적용하여 생성하였다.

---

## 모델링

### 모델링 과정

![image](https://user-images.githubusercontent.com/38115693/147495960-f9e2e82c-6d3d-4d84-a875-f63e3d33732a.png)

모델링은 크게 세 가지 과정을 거친다.
1. 데이터 전처리
2. Imbalanced 데이터 처리를 위한 오버 샘플링
3. 파라미터 튜닝

### 사용한 데이터 처리 기법 및 학습/예측 모델

![image](https://user-images.githubusercontent.com/38115693/147496168-a3211c99-e055-4805-bbf3-1771d3072fcf.png)

1. 범주형 데이터를 사용한 모델링시 인코딩은 Label Encoding과 One-Hot Encoding을 각각 사용하였고, 연속형 데이터만으로 Standard Scaling을 따로 적용하여서도 모델링해 보았다.
2. Label 2437개 중 0: 2231개 / 1: 206개의 불균형 데이터이기 때문에, 불균형 데이터 처리를 위해 리샘플링을 하였는데, 데이터 양이 많지 않아 오버샘플링을 하기로 결정하였다.
3. DecisionTree, KNN, LogisticRegression, RandomForest, XGBoost, SVM 분류기 등 9개의 모델을 사용해서 학습과 모델링을 진행하였다.

### 세부 모델링 과정

#### 1. 데이터 전처리

![image](https://user-images.githubusercontent.com/38115693/147497046-b62286eb-5ead-44c8-9515-808e3f3152ab.png)

모델링은 3가지로 나눠서 접근해 시도하였다.

우선, 기존의 각 검사수치 변수(연속형)들을 그룹핑하여 범주화하였고, 해당 범주형 변수들로만 학습/예측 모델링을 시도했다. 범주형 데이터 처리를 위해 인코딩을 하였는데, 아래와 같은 이유로 Label Encoding과 One-Hot Encoding을 각각 진행하게 되었다:
1. 데이터를 그룹화 하여 나눠 놨지만, 레이블 인코딩을 했을 때 각각의 수치 값이, 예를 들어, 정상 미만(0), 정상(1), 정상 이상(2) 등과 같은 순서가 있는 데이터처럼 되었기에, 레이블 인코딩를 사용해도 각 수치 값의 의미가 보존되지 않을까 생각하여 레이블 인코딩도 진행하였다.
2. 선형 계열 모델(로직스틱회귀, SVM, 신경망 등)의 경우 숫자의 차이가 모델에 영향을 미치기 때문에, 레이블 인코딩된 결과에 이에 대한 영향이 있을 수도 있어 원핫인코딩 또한 별도로 적용하여 진행하였다.

마지막으로, 당뇨병에 대한 조사를 하면서, 각 검사 수치에 대한 판단 기준이 자료마다, 병원마다 달랐고, 따라서 조사한 것과 자료들을 기반으로 판단하여 범주화한 것이 예측 성능에 영향을 줄 수도 있을 것 같아 기존의 연속형 변수들만을 사용하여 스케일링 적용 후 모델링하는 것도 시도하였다.

그리고 성능 테스트 과정에서 의미가 있을 것으로 판단되는 경우 범주화된 데이터셋에 일부 스케일링된 변수를 추가하거나, 반대로 스케일링된 데이터셋에 범주형 변수를 합쳐서도 시도하였다.

#### 2. 오버샘플링

![image](https://user-images.githubusercontent.com/38115693/147497557-b2dab919-761d-4e4f-bd84-620556ee9de4.png)

오버샘플링은 5가지 기법을 사용하였으며, 적용 대상 데이터셋의 특성(범주형, 연속형, 범주형+연속형)에 맞춰 적절한 기법을 사용했다.

1. Random Oversampling(ROS): 기존에 존재하는 소수의 클래스(Minority)를 복제하여 비율을 맞춰주는 기법다. 숫자가 늘어나기 때문에 더 많은 가중치를 받게 되는 원리이다.
2. SMOTE: 임의의 소수 클래스 데이터로부터 인근 소수 클래스(minor class) 사이에 새로운 데이터를 생성하는 기법이다. 임의의 소수 클래스에 해당하는 관측치 X를잡고, 그 X로부터 가장 가까운 K개의 이웃을 찾아 그 사이에 임의의 새로운 X를 생성하는 데이터로부터 인근 소수 클래스 사이에 새로운 데이터를 생성한다. 
3. ADASYN: Borderline-SMOTE에서 조금 더 변주를 준 알고리즘으로, 인접한 다수 클래스의 비율에 따라 가중치를 줘 SMOTE를 적용시키는 방식이다.
4. SMOTE-NC: SMOTE가 수치형/연속형 데이터로만 이루어진 데이터에 적합한 반면, SMOTE-NC는 범주형과 수치형이 믹스된 데이터에 적용할 수 있는 기법이다.
5. SMOTE-N: SMOTE-N은 범주형으로만 이루어진 데이터에 적합한 SMOTE 기법이다.

#### 3. 하이퍼파라미터 튜닝

각 전처리 및 오버샘플링 과정별로 하이퍼 파라미터 튜닝을 진행하였는데,
DecisionTree와 KNN을 베이스 모델로 삼고 다른 여러 모델들을 시도해 보면서 성능을 비교하며 파라미터 옵션을 추가하거나 값을 변경해 갔습니다.
암 진단과 같이 당뇨병 진단도 실제 양성을 양성으로 예측하는 것이 중요하다고 판단하여,
Accuracy와 함께 recall(재현율) 예측율을 높이는 것에 중점을 두어 파라미터 튜닝을 진행하였습니다.



References
https://www.amc.seoul.kr/asan/healthinfo/disease/diseaseDetail.do?contentId=31596
https://www.kosso.or.kr/newsletter/202104/sub02.html
https://www.hidoc.co.kr/healthstory/news/C0000633143
https://www.joongang.co.kr/article/24109084#home
https://kdca.go.kr/board/board.es?mid=a40303030000&bid=0034&act=view&list_no=716754
